--- .orig/etc/palm/db/permissions/com.palm.person.speeddialbackup
+++ /etc/palm/db/permissions/com.palm.person.speeddialbackup
@@ -31,5 +31,16 @@
 			"delete": "allow",
 			"update": "allow"
 		}
-	}
+	},
+	{
+		"type": "db.kind",
+		"object": "com.palm.person.speeddialbackup:1",
+		"caller": "com.palm.app.phone",
+		"operations": {
+			"read": "allow",
+			"create": "allow",
+			"delete": "allow",
+			"update": "allow"
+		}
+	}	
 ]
--- .orig/usr/palm/applications/com.palm.app.phone/sources.json
+++ /usr/palm/applications/com.palm.app.phone/sources.json
@@ -141,6 +141,9 @@
     "source": "app/controllers/pin-assistant.js"
   },
   {
+    "source": "app/controllers/prefs-assistant.js"
+  },
+  {
     "source": "app/models/DBModels.js"
   },
   {
@@ -172,6 +175,9 @@
     "source": "app/models/states/Abstract.js"
   },
   {
+    "source": "app/models/states/Prefs.js"
+  },
+  {
     "source": "app/models/states/Start.js"
   },
   {
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/app-assistant.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/app-assistant.js
@@ -2,6 +2,10 @@
 
 function AppAssistant(appController) {
 	var libraries;
+
+	this.phonePrefs = {};
+	this.rejectedPrefs = {};
+	this.notificationPrefs = {};
 	
    // Mojo.Log.info( "AppAssistant");
 
@@ -77,6 +81,8 @@
 		Mojo.Log.error("PHONE APP FAILED TO LOAD BECAUSE AN EXCEPTION WAS THROWN BY A DEPENDENCY. EXCEPTION DETAILS TO FOLLOW.");
 		throw e;
 	}
+
+	this.loadPreferences();
 };
 
 AppAssistant.prototype.setup = function() {
@@ -108,6 +114,10 @@
 	} else if (event.type == Mojo.Event.command) {
 		// handle app menu items common to all scenes
 		switch (event.command) {
+			case MenuController.kPrefsMenuItem.command:
+				UIStateMachine.enter('prefs', this.phonePrefs, this.rejectedPrefs, this.notificationPrefs);
+				break;
+
 			case Mojo.Menu.prefsCmd:
 				MenuController.showPrefs();
 				break;
@@ -134,6 +144,50 @@
 	}
 };
 
+AppAssistant.prototype.loadPreferences = function() {
+	var cookieContainer = new Mojo.Model.Cookie("phone");
+
+	this.phonePrefs = cookieContainer.get();
+	
+	if(!this.phonePrefs) {
+		this.phonePrefs = {
+			version: 1,
+			closeApp: false,
+			startView: "default",
+			onCallView: "contact",
+			autoDialing: "call",
+			powerButton: "none",
+			sliderOpened: "answer",
+			sliderClosed: "hangup",
+			removedFromTS: "answer",
+			proximityAction: "none"
+		};
+		
+		cookieContainer.put(this.phonePrefs);
+	}
+
+	this.rejectedPrefs = {
+		rejectAction: "none",
+		rejectTemplate: "Sorry, I am currently busy and will call you back later..."
+	};
+	
+	this.notificationPrefs = {
+		notificationBlink: true,
+		repeatInterval: 0,
+		repeatLimit: 3
+	};
+
+	this.getPreferencesSubscription = new Mojo.Service.Request('palm://com.palm.systemservice/', {
+		method: 'getPreferences', parameters: {subscribe: true, keys: ["callRejection", "callNotification"]},
+		onSuccess: function(response) {
+			if(response.callRejection)
+				this.rejectedPrefs = response.callRejection;
+			
+			if(response.callNotification)
+				this.notificationPrefs = response.callNotification;
+		}.bind(this)});
+}
+
 AppAssistant.prototype.loadProperties = function() {
 	var sourcesText = palmGetResource(Mojo.appPath + "properties.json", true);
 	if (sourcesText) {
@@ -271,11 +325,17 @@
 			this.createLockStage();
 			this.loadSettings();
 			return;
+		} else if (args.closeMissedCall) {
+			Mojo.Controller.getAppController().closeStage("missed");
+		} else if (args.playNotificationSound) {
+			// Delay playing to go around WebOS bug (sound not playing).
+
+			setTimeout(this.playNotificationSound.bind(this, args.playNotificationSound), 1000);
 		} else {
 			// when in first use, always default to doing nothing for invalid args; 
 			// otherwise default to showing dialpad
 			if ( ! PalmSystem.isMinimal ) {
-				UIStateMachine.event("launch");
+				UIStateMachine.event("launch", this.phonePrefs.startView);
 			}
 		}
     } else {
@@ -283,8 +343,8 @@
 		if (!(this.telephonyEventListener.isPendingOrActive())) {
 			if (this.initialLaunch === false) {
 				Mojo.Log.info( "handleLaunch", "no args, no calls: focusing stage");
-				
-				UIStateMachine.event("launch");
+
+				UIStateMachine.event("launch", this.phonePrefs.startView);
 			} else {
 				Mojo.Log.info( "handleLaunch", "initial launch, so doing nothing");
 				this.initialLaunch = false;
@@ -297,6 +357,16 @@
     }
 };
 
+AppAssistant.prototype.playNotificationSound = function(count) {
+	var stageController = Mojo.Controller.getAppController().getStageController("misseddash");
+
+	if (stageController) {
+		stageController.delegateToSceneAssistant("playNotificationSound");
+
+		stageController.delegateToSceneAssistant("schedulePlayNotificationSoundTask", count);
+	}
+};
+
 // Public API way of launching the phone app to a number (or opening skypevm)
 AppAssistant.prototype.launchURI = function(uri) {
 	var uriNoPrefix = uri.replace(/^((tel:)|(wtai:)|(skypevm:\/\/))/,''),
@@ -394,7 +464,10 @@
 				|| contact.addr.charAt(0) === '#'
 				|| ! this.telephonyEventListener.serviced)) {
 			
-			UIStateMachine.event("dial", {"action": "dial", "number": contact.addr});
+			if(this.phonePrefs.autoDialing != "none")
+				UIStateMachine.event("dial", {"action": "dial", "number": contact.addr});
+			else
+				UIStateMachine.event("dial", {"action": "fill", "number": contact.addr});
 		
 		// CASE: just dial
 		} else {
@@ -407,11 +480,16 @@
 				} else {
 					this.focusOnActiveCallSceneCreation = true;
 				}
-				contact.placeCall(this.dialFailure.bind(this), parseResult);
-			
+				if(this.phonePrefs.autoDialing != "none")
+					contact.placeCall(this.dialFailure.bind(this), parseResult);
+				else
+					UIStateMachine.event("dial", {"action": "fill", "number": contact.addr});
 			// CASE: not immediately dialable. Let dialpad try it
 			} else {
-				UIStateMachine.event("dial", {"action": "dial", "number": contact.addr});
+				if(this.phonePrefs.autoDialing != "none")
+					UIStateMachine.event("dial", {"action": "dial", "number": contact.addr});
+				else
+					UIStateMachine.event("dial", {"action": "fill", "number": contact.addr});
 			}
 		}
 		
@@ -751,4 +829,4 @@
 		default:
 			this.nanpRegion = false;
 	} 
-};
\ No newline at end of file
+};
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/activecall-assistant.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/activecall-assistant.js
@@ -29,7 +29,30 @@
 		this.announcer = this.appAssistant.announcer;
 		this.contacts = this.appAssistant.contacts; 
         Mojo.Log.info( "activecall initialize");
+
+		this.audioPreviousProfile = null;
+		this.sliderState = "down";
+
+      var sliderStateRequest = new Mojo.Service.Request('palm://com.palm.keys/switches/', {
+			method: 'status', parameters: {"get" : "slider"},
+			onSuccess: function(response) {
+				if(response.key === "slider")
+					this.sliderState = response.state;
+			}.bind(this)});
+
+		this.sliderSubscription = TelephonyCommands.sliderSubscribe(
+			this.onSliderEventDuringCall.bind(this));
        	
+		if(this.appAssistant.phonePrefs.powerButton == "hangup") {
+			this.powerButtonSubscription = TelephonyCommands.powerButtonSubscribe(
+			true, 'activecall', this.onPowerButtonEventDuringCall.bind(this));
+		}
+
+		if(this.appAssistant.phonePrefs.proximityAction == "change") {
+			this.displayStatusSubscription = TelephonyCommands.displayStatusSubscribe(
+				this.onDisplayEventDuringCall.bind(this));
+		}
+				
 		this.lastLines = [];
 		this.pauseWaitDigits = [];
 		this.showWaitButtonOnActive = [];
@@ -151,7 +174,7 @@
 		this.appAssistant.telephonyEventListener.addCallStateListener(this);
 		this.appAssistant.telephonyEventListener.addAudioStateListener(this);
 		
-		var appMenuModel = {
+/*		var appMenuModel = {
 			visible: true,
             items: [{
                 label: $L('Sounds & Ringtones'),
@@ -159,6 +182,8 @@
             }]
 		}; 
 		this.controller.setupWidget(Mojo.Menu.appMenu, undefined, appMenuModel);
+*/		
+		MenuController.setupAppMenu(this.controller);
 		
 		if (!this.abridged && this.appAssistant.focusOnActiveCallSceneCreation === true) {
 			UIStateMachine.event('focus');
@@ -558,7 +583,9 @@
 		if (this.showDTMF === true && lineState.length > 0 && !(lineState.length == 1 && this.lastLines.length == 1 
 			&& (lineState[0].state == TelephonyCallState.ACTIVE || lineState[0].state == TelephonyCallState.DIALPENDING)
 			&& (this.lastLines[0].state == TelephonyCallState.DIALING || this.lastLines[0].state == TelephonyCallState.DIALPENDING))) {
-				this.setDTMFPadVisibility(false);
+					
+				if(this.appAssistant.phonePrefs.onCallView != "keypad")
+					this.setDTMFPadVisibility(false);
 		} 
 	},
 	
@@ -1242,6 +1269,9 @@
 		// clear dial debounce
 		DialStringParser.clearDebounceTimeout();
 		this.activated = true;
+		
+		if(this.appAssistant.phonePrefs.onCallView == "keypad")
+			this.setDTMFPadVisibility(true);
 	},
     
 	incomingDialogLaunch: function() {
@@ -1302,7 +1332,23 @@
 		this.controller.document.removeEventListener("mouseup", this.boundEndContinuousDTMF);
         this.controller.document.removeEventListener('keydown', this.boundStartDTMFHardKey);
         this.controller.document.removeEventListener('keyup', this.boundEndDTMFHardKey);
-		
+
+      // remove slider listener
+		this.sliderSubscription.cancel();
+		delete this.sliderSubscription;
+		
+		 // remove power button listener
+		if(this.appAssistant.phonePrefs.powerButton == "hangup") {
+			this.powerButtonSubscription.cancel();
+			delete this.powerButtonSubscription;
+		}
+
+		 // remove display status listener
+		if(this.appAssistant.phonePrefs.proximityAction == "change") {
+			this.displayStatusSubscription.cancel();
+			delete this.displayStatusSubscription;
+		}
+	
 		// drop puck subscription
 		this.puckSubscription.cancel();
 		delete this.puckSubscription;
@@ -1519,7 +1565,9 @@
     },
     
     enableSpeakerphoneOnPuck: function(){
-        if (this.puckConnected === true && this.audioActiveProfile !== "phone_back_speaker") {
+        if (this.puckConnected === true && this.audioActiveProfile !== "phone_back_speaker" &&
+        		this.audioActiveProfile === "phone_front_speaker")
+        {
             this.onAudioRouteChangeClick("phone_back_speaker");
         }
 	},
@@ -2058,5 +2106,81 @@
 			}(), 500);
 		}
 	},
-    
+   
+	onSliderEventDuringCall: function(response) {
+		if((!response) || (!response.key) || (!response.state))
+			return;
+
+		if(this.appAssistant.phonePrefs.sliderClosed == "none")
+			return;
+
+		if((response.key == "slider") && (this.audioActiveProfile == "phone_front_speaker")) {
+			if((this.sliderState == "up") && (response.state == "down")) {
+				// First, "tap" each Disconnect Button.
+
+				for(i = 0; i < 3; i++) {
+					if(this.controller.get("disc_button_" + i))
+						Mojo.Event.send(this.controller.get("disc_button_" + i), Mojo.Event.tap);
+				}
+
+				// In case there are calls not disconnected, just call the function to disconnect all calls.
+				// The reason we don't just do this one function is that the screen redraw is not pretty.
+
+				this.eventListener.disconnectAllCalls();
+			}
+		
+			this.sliderState = response.state;
+		} 
+	},
+
+	onPowerButtonEventDuringCall: function(response) {
+		if((!response) || (!response.powerKey))
+			return;
+
+		if(this.appAssistant.phonePrefs.powerButton == "none")
+			return;
+
+		if((response.powerKey == 'released') && (this.audioActiveProfile !== "phone_back_speaker")) {
+			// First, "tap" each Disconnect Button.
+
+			for(i = 0; i < 3; i++) {
+				if(this.controller.get("disc_button_" + i))
+					Mojo.Event.send(this.controller.get("disc_button_" + i), Mojo.Event.tap);
+			}
+
+			// In case there are calls not disconnected, just call the function to disconnect all calls.
+			// The reason we don't just do this one function is that the screen redraw is not pretty.
+
+			this.eventListener.disconnectAllCalls();
+		}
+	},
+	
+	onDisplayEventDuringCall: function(response) {
+		if(this.appAssistant.phonePrefs.proximityAction != "change")
+			return;
+		
+		if(this.eventListener.proxEnabled) {
+			var callStateMessage = this.eventListener.getCallState();
+			var lineState = callStateMessage.lines;
+			
+			var scenarios = this.eventListener.getAvailableAudioScenarios();
+			
+			if(response && (response.event || response.state)) {
+				if(response.event == "displayOn" || response.state == "on") {
+					if(this.audioActiveProfile !== this.audioPreviousProfile) {
+						if(this.audioPreviousProfile !== null)
+							this.onAudioRouteChangeClick(this.audioPreviousProfile);
+					}
+				} else if(response.event == "displayOff" || response.state == "off") {
+					if(this.audioActiveProfile !== "phone_front_speaker") {
+						this.audioPreviousProfile = this.audioActiveProfile;
+						
+						this.onAudioRouteChangeClick("phone_front_speaker");						
+					}
+					else if(this.audioPreviousProfile === null)
+						this.audioPreviousProfile = "phone_back_speaker";
+				}
+			}
+		}
+	}
 });
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/announcer-assistant.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/announcer-assistant.js
@@ -47,7 +47,7 @@
 	onAnnounceCreated: function(windowName, single, icon, itemcount, title, message, iconCallback, messageCallback, timestamp, badgeTemplate, stagecontrol) {
 		Mojo.Log.info( "onAnnounceCreated");
 		
-		stagecontrol.pushScene({"name": "dashannounce"}, windowName, single, icon, itemcount, title, message, iconCallback, messageCallback, timestamp, badgeTemplate);
+		stagecontrol.pushScene({"name": "dashannounce"}, windowName, single, icon, itemcount, title, message, iconCallback, messageCallback, timestamp, badgeTemplate, this.appAssistant.notificationPrefs);
 	},
 
 	announceClear: function(windowName) {
@@ -471,6 +471,9 @@
 			soundClass = "ringtones";
 		}
 		
+		if(contact.callAlert)
+			soundClass = contact.callAlert;
+		
 		/* TODO if you want to override the ringer switch when a charger connected, 
 			(puck or USB) comment out the code above and replace it with this.
 		
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/dashannounce-assistant.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/dashannounce-assistant.js
@@ -1,7 +1,7 @@
 /* Copyright 2009 Palm, Inc.  All rights reserved. */
 
 var DashannounceAssistant = Class.create({
-	initialize: function(windowName, single, icon, itemcount, title, message, iconCallback, messageCallback, timestamp, badgeTemplate) {
+	initialize: function(windowName, single, icon, itemcount, title, message, iconCallback, messageCallback, timestamp, badgeTemplate, notificationPrefs) {
 	    Mojo.Log.info( "DashannounceAssistant::initialize");
 	   	this.windowName = windowName;
 		this.single = single;
@@ -11,6 +11,7 @@
 		this.message = message;
 		this.iconCallback = iconCallback;
 		this.badgeTemplate = badgeTemplate;
+		this.notificationPrefs = notificationPrefs;
 		if (messageCallback) {
 			this.messageCallback = messageCallback;
 		} else {
@@ -40,7 +41,11 @@
 	   this.controller.get('title').innerHTML = this.title;
 	   this.controller.get('message').innerHTML = this.message;
 	   this.controller.listen(this.controller.document, Mojo.Event.windowActivate, this.onFocus.bindAsEventListener(this));
-	   this.controller.stageController.indicateNewContent(true);
+
+		if(this.notificationPrefs.notificationBlink)
+		   this.controller.stageController.indicateNewContent(true);
+
+		this.schedulePlayNotificationSoundTask(0);
   },
   onFocus:function() {
   	if (this.missedTimeStamp && this.windowName == 'misseddash') {
@@ -57,11 +62,15 @@
   deactivate:function(){
 	this.controller.stopListening(this.controller.document, Mojo.Event.windowActivate, this.onFocus);
   	
+	this.removePlayNotificationSoundTask(); 
   },
 
   // run callback and close this
   onIconTap: function () {
 	Mojo.Log.info( "DashannounceAssistant::onTap", "windowName:" , this.windowName);
+
+	this.removePlayNotificationSoundTask(); 
+	
 	if (this.iconCallback) {
 		this.iconCallback();
 	} else {
@@ -71,6 +80,9 @@
   
   onMessageTap: function () {
 	Mojo.Log.info( "DashannounceAssistant::onTap", "windowName:" , this.windowName);
+
+	this.removePlayNotificationSoundTask(); 
+	
 	if (this.messageCallback) {
 		this.messageCallback();
 	} else {
@@ -80,6 +92,7 @@
   
   updateMessage: function(header, body, itemcount, timestamp, badgeTemplate) {
   	Mojo.Log.info("DashannounceAssistant::updateMessage");
+
 	if (this.windowName == 'misseddash' && timestamp) {
 		this.missedTimeStamp = timestamp;
 	}
@@ -91,7 +104,11 @@
 	this.itemcount = itemcount;
 	this.badgeTemplate = badgeTemplate;
 	this.updateBadge();
-	this.controller.stageController.indicateNewContent(true);
+
+	if(this.notificationPrefs.notificationBlink)
+		this.controller.stageController.indicateNewContent(true);
+
+	this.schedulePlayNotificationSoundTask(0);
   },
   
   updateBadge: function() {
@@ -115,7 +132,45 @@
 		this.controller.get('badge').innerHTML = "";
 		this.controller.get('notification').addClassName("single");
 	}
-  }
+  },
   
+	schedulePlayNotificationSoundTask: function(count) {
+		if((this.notificationPrefs.repeatInterval > 0) && (count++ < this.notificationPrefs.repeatLimit)) {
+			var currentTime = new Date();
+		
+			var repeatInterval = this.notificationPrefs.repeatInterval;				
+			
+			var playSoundTime = new Date(currentTime.getTime() + (parseInt(repeatInterval) * 1000));
+
+			var month = playSoundTime.getUTCMonth()+1;
+			if(month < 10) month = "0" + month;
+			var day = playSoundTime.getUTCDate();
+			if(day < 10) day = "0" + day;
+			var year = playSoundTime.getUTCFullYear();
+
+			var hours = playSoundTime.getUTCHours();
+			if(hours < 10) hours = "0" + hours;
+			var minutes = playSoundTime.getUTCMinutes();
+			if(minutes < 10) minutes = "0" + minutes;
+			var seconds = playSoundTime.getUTCSeconds();
+			if(seconds < 10) seconds = "0" + seconds;
+
+			var scheduledTimeStr = month + "/" + day + "/" + year + " " + hours + ":" + minutes + ":" + seconds;
+			
+			this.updateTimeoutRequest = new Mojo.Service.Request('palm://com.palm.power/timeout/', {
+				'method': "set", 'parameters': {'key': 'phonePlayNotificationSound',
+				'wakeup': true, 'at': scheduledTimeStr, 'uri': "palm://com.palm.applicationManager/open",
+				'params': {'id': 'com.palm.app.phone', 'params': {'playNotificationSound': count}}} }); 
+		}
+	},
+	
+	removePlayNotificationSoundTask: function() {
+		this.removeTimeoutRequest = new Mojo.Service.Request("palm://com.palm.power/timeout/", {
+			'method': "clear", 'parameters': {"key": 'phonePlayNotificationSound'} });
+	},
+
+	playNotificationSound: function() {
+		Mojo.Controller.getAppController().playSoundNotification("notifications");
+	}
 });
 
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/dialpad-assistant.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/dialpad-assistant.js
@@ -476,7 +476,6 @@
 			
 		} else if (event.type == Mojo.Event.command) {
 			switch (event.command) {
-				
 				case 'logging-verbose-cmd':
 					TelephonyCommands.loggingVerboseSet(true);
 					break;
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/menu-controller.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/menu-controller.js
@@ -8,7 +8,7 @@
 	that = this;
 	originalHandleCommand = controller.handleCommand;
 	
-	controller.setupWidget(Mojo.Menu.appMenu, undefined, {
+	controller.setupWidget(Mojo.Menu.appMenu, {omitDefaultItems: true}, {
 		visible: true,
         items: appMenuItems
 	});
@@ -34,14 +34,23 @@
 };
 
 MenuController._getAppMenuItems = function(prefixItems) {
-	var items = prefixItems ? prefixItems.slice(0) : []; // always clone array
+	var items = [];
+	
+	items.push(Mojo.Menu.editItem);
+
+	if(prefixItems)
+		items = items.concat(prefixItems);	
 	
 	// add 'Check Skype Balance' if we have a skype account
 	if ( CallSynergy.isSkypeCapable() && CallSynergy.hasSkypeAccount() ) {
 		items.push(MenuController.kSkypeBalanceMenuItem);
 	}
+
 	
 	items.push(MenuController.kRingtonesMenuItem);
+	items.push(MenuController.kServicesMenuItem);
+	items.push(MenuController.kPrefsMenuItem);	
+	items.push(Mojo.Menu.helpItem);
 	
 	return items;
 };
@@ -86,4 +95,6 @@
 };
 
 MenuController.kSkypeBalanceMenuItem = {label: $L('Check Skype Credit'), command: 'skypebalance'};
-MenuController.kRingtonesMenuItem = {label: $L('Sounds & Ringtones'), command: 'ringtones'};
\ No newline at end of file
+MenuController.kRingtonesMenuItem = {label: $L('Ringtone Settings'), command: 'ringtones'};
+MenuController.kServicesMenuItem = {label: $L('Network Services'), command: Mojo.Menu.prefsCmd};
+MenuController.kPrefsMenuItem = {label: $L('Preferences'), command: 'phoneprefs'};
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/missedcall-assistant.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/missedcall-assistant.js
@@ -30,11 +30,37 @@
 		this.setupScene();
 		
 		// stay up for 1 minute
-		this.missedTimeout = window.setTimeout(this.closeWindow.bind(this), MissedcallAssistant.kTimeoutMs);
+//		this.missedTimeout = window.setTimeout(this.closeWindow.bind(this), MissedcallAssistant.kTimeoutMs);
 		
 		this.controller.listen(this.controller.stageController.document, Mojo.Event.windowDeactivate, this.onBlur);
 		this.telListener.displayStateRegisterCallback(this.onDisplayEvent);
-		this.controller.stageController.indicateNewContent(true);
+
+		if(this.appAssistant.notificationPrefs.notificationBlink)
+			this.controller.stageController.indicateNewContent(true);
+
+		var missedTimeout = new Date();
+		
+		missedTimeout = new Date(missedTimeout.getTime() + MissedcallAssistant.kTimeoutMs);
+
+		var month = missedTimeout.getUTCMonth()+1;
+		if(month < 10) month = "0" + month;
+		var day = missedTimeout.getUTCDate();
+		if(day < 10) day = "0" + day;
+		var year = missedTimeout.getUTCFullYear();
+
+		var hours = missedTimeout.getUTCHours();
+		if(hours < 10) hours = "0" + hours;
+		var minutes = missedTimeout.getUTCMinutes();
+		if(minutes < 10) minutes = "0" + minutes;
+		var seconds = missedTimeout.getUTCSeconds();
+		if(seconds < 10) seconds = "0" + seconds;
+
+		var scheduledTimeStr = month + "/" + day + "/" + year + " " + hours + ":" + minutes + ":" + seconds;
+
+		this.controller.serviceRequest('palm://com.palm.power/timeout/', {'method': "set", 
+			'parameters': {'key': 'phoneMissedTimeout', 'wakeup': true, 'at': scheduledTimeStr, 
+			'uri': "palm://com.palm.applicationManager/open", 'params': {
+				'id': 'com.palm.app.phone', 'params': {'closeMissedCall': true}}} }); 
     },
 	
 	cleanup: function() {
--- .orig/usr/palm/applications/com.palm.app.phone/app/controllers/incomingcall-assistant.js
+++ /usr/palm/applications/com.palm.app.phone/app/controllers/incomingcall-assistant.js
@@ -69,8 +69,9 @@
 		}
 		
 		try {
-			this.sceneCtrl.get('answer_button').addEventListener(Mojo.Event.tap, this.answerCall.bind(this));
-			this.sceneCtrl.get('reject_button').addEventListener(Mojo.Event.tap, this.rejectCall.bind(this));
+			this.sceneCtrl.get('answer_button').addEventListener(Mojo.Event.tap, this.answerCall.bindAsEventListener(this));
+			this.sceneCtrl.get('reject_button').addEventListener(Mojo.Event.tap, this.rejectCall.bindAsEventListener(this, false));
+			this.sceneCtrl.get('reject_button').addEventListener(Mojo.Event.hold, this.rejectCall.bindAsEventListener(this, true));
 			
 	        this.exposed = true;
 			// turn display on and lock it there
@@ -331,12 +332,16 @@
 			return;
 		}
 		
-		if (response.key === "slider") {
+		if(response.key === "slider") {
 			var newSliderOpenState = (response.state === "up");
-			if (this.exposed
-				&& this.sliderOpen === false 
-				&& newSliderOpenState === true) {
-					this.answerCall();
+			if((this.sliderOpen === false) && (newSliderOpenState === true)) {
+				if(this.appAssistant.phonePrefs.sliderOpened != "none") {
+					if(this.exposed)
+                  this.answerCall(); 
+					
+					if(this.appAssistant.phonePrefs.sliderOpened == "speaker")
+						TelephonyCommands.setAudioScenario("phone", "phone_back_speaker");
+				}
 			}
 			this.sliderOpen = newSliderOpenState;
 		} 
@@ -372,8 +377,10 @@
 		// answer the call after a delay if we're exposed, set to do so, 
 		// and we were previously on the puck
 		if (response && response.type == "inductive") {
-			if (this.appAssistant.puckMode && this.exposed && this.puckConnected === true && response.connected === false) {
-				this.answerIfStillOffPuck.bind(this).delay(0.750);
+			if(this.appAssistant.phonePrefs.removedFromTS == "answer") {
+				if (this.appAssistant.puckMode && this.exposed && this.puckConnected === true && response.connected === false) {
+					this.answerIfStillOffPuck.bind(this).delay(0.750);
+				}
 			}
 			this.puckConnected = response.connected;
 		}
@@ -416,7 +423,9 @@
     },
     
 	// hide alert and instruct blur handler to disconnect call & show ignored UI
-	rejectCall: function(event){
+	rejectCall: function(event, hold){
+		event.stop();
+		
         if (this.blockIgnore) {
 			Mojo.Log.error( "IncomingcallAssistant#rejectCall tapped too soon");
 			this.unblockIgnore();
@@ -427,6 +436,17 @@
 		this.exitStatus = "rejected";
 		
       	this.closeWindow();
+
+		if((this.contact.canBeCalled()) && (this.contact.service != CallSynergy.SERVICES.SKYPE)) {
+			if((hold) && (this.appAssistant.rejectedPrefs.rejectAction == "autoreply")) {	
+				this.controller.serviceRequest('palm://com.palm.applicationManager/', {
+					method: 'launch', parameters: { id: 'com.palm.app.messaging',
+						params: {composeRecipients: [{address: this.contact.addressFormatted}],
+						messageText: this.appAssistant.rejectedPrefs.rejectTemplate
+						}
+				}});
+			}
+		}
     },
 	
 	// hide alert and instruct blur handler to show ignore UI
--- .orig/usr/palm/applications/com.palm.app.phone/stylesheets/phone.css
+++ /usr/palm/applications/com.palm.app.phone/stylesheets/phone.css
@@ -365,4 +365,13 @@
 
 .palm-dark .favorites-list .palm-drag-spacer {
   -webkit-border-image: url(../images/empty.png) 15 15 15 15 repeat repeat;
-}
\ No newline at end of file
+}
+
+body.prefs {
+	background-image: none;
+	background-color: rgba(228,228,228,1.0);
+}
+
+.palm-page-header .icon.phone {
+	background-image: url(../images/header-icon-phone.png);
+}
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/states/ActiveCallCard.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/states/ActiveCallCard.js
@@ -70,9 +70,13 @@
 		if ( okToGoBackToStates.indexOf(prevState) < 0 ) {
 			prevState = this.machine.STATE_DIALPAD_CARD;
 		}
+	
+		var cookieContainer = new Mojo.Model.Cookie("phone");
+
+		var prefs = cookieContainer.get();
 		
 		// if stage was hidden when active call started (and not firstuse), hide it
-		if ( this.wasHidden && stageController && stageController.fullInit && ! PalmSystem.isMinimal ) {
+		if ( ((prefs.closeApp) || (this.wasHidden && stageController && stageController.fullInit)) && ! PalmSystem.isMinimal ) {
 			stageController.window.PalmSystem.hide();
 		}
 		
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/states/CallLog.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/states/CallLog.js
@@ -14,6 +14,14 @@
 	cleanup: function() {
 		
 	},
+	event_launch: function(view) {
+		if(view == "calllog")
+			this.machine.enter('calllog');
+		else if(view == "favorites")
+			this.machine.enter('favorites');
+		else if(view == "dialpad")
+			this.machine.enter('dialpad_card');
+	},
 	event_back: function(commandEvent) {
 		this.machine.enter('dialpad_card');
 	},
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/states/DialpadCard.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/states/DialpadCard.js
@@ -10,6 +10,14 @@
 			stageController.delegateToSceneAssistant("resetOnHide");
 		}
 	},
+	event_launch: function(view) {
+		if(view == "calllog")
+			this.machine.enter('calllog');
+		else if(view == "favorites")
+			this.machine.enter('favorites');
+		else if(view == "dialpad")
+			this.machine.enter('dialpad_card');
+	},
 	event_back: function(commandEvent) {
         if ( this.appAssistant.telephonyEventListener.callExists() ) {
             this.machine.enter("activecall_card");
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/states/Favorites.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/states/Favorites.js
@@ -8,6 +8,14 @@
 	cleanup: function() {
 		
 	},
+	event_launch: function(view) {
+		if(view == "calllog")
+			this.machine.enter('calllog');
+		else if(view == "favorites")
+			this.machine.enter('favorites');
+		else if(view == "dialpad")
+			this.machine.enter('dialpad_card');
+	},
 	event_back: function(commandEvent) {
 		this.machine.enter('dialpad_card');
 	},
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/states/FavoritesAdd.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/states/FavoritesAdd.js
@@ -48,7 +48,6 @@
 			scenesToPush: [ContactsUI.FavoritePersonWidget.SCENES.PERSON_PICKER, ContactsUI.FavoritePersonWidget.SCENES.CONTACT_POINT_PICKER],
 			defaultType: this._getDefaultType(),
 			callback: function() {
-				this.machine.enter("favorites");
 			}.bind(this)
 		}).pushScene();
 	},
@@ -62,7 +61,6 @@
 			listIndexForDefault: lastIndex,
 			defaultType: this._getDefaultType(),
 			callback: function() {
-				this.machine.enter("favorites");
 			}.bind(this)
 		}).pushScene();
 	},
@@ -73,4 +71,4 @@
 		}
 		return defaultType;
 	}
-});
\ No newline at end of file
+});
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/states/Start.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/states/Start.js
@@ -7,8 +7,13 @@
 		
 	},
 	// always launch to dialpad first
-	event_launch: function() {
-		this.machine.enter('dialpad_card');
+	event_launch: function(view) {
+		if(view == "calllog")
+			this.machine.enter('calllog');
+		else if(view == "favorites")
+			this.machine.enter('favorites');
+		else
+			this.machine.enter('dialpad_card');
 	},
 	event_emergency: function(isEnabled) {
 		if ( isEnabled ) {
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/TelephonyEventListener.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/TelephonyEventListener.js
@@ -506,6 +506,10 @@
 					&& Object.keys(profiles).length == 2 				
 					&& profiles["phone_front_speaker"] == true) {
 					scenario = "phone_front_speaker";
+				} else if (!this.puckConnected && 
+					Object.keys(profiles).length == 2
+					&& profiles["phone_back_speaker"] == true) {
+					scenario = "phone_back_speaker";
 				} else {
 					return;
 				}
@@ -513,7 +517,7 @@
 		}
 		
 		if (this.isPendingOrActive()) {
-			if (scenario == "phone_front_speaker") {
+			if ((scenario == "phone_front_speaker") || (this.appAssistant.phonePrefs.proximityAction == "change")) {
 				this.proxOn();
 			} else {
 				Mojo.Log.info( "TEL#enableProxOnCallAndAudio", "not enabled: " , scenario);
@@ -724,7 +728,33 @@
 		// wait to show incoming popup until the contact has been decorated
 		future = this.incomingPending.contact.decorated();
 		future.then(this, function() {
-			this.announcer.announceIncoming(callState.affectedCallId, future.result, this.isConnected());
+			this.contactPrefs = new window.Contacts.AppPrefs(function(contact) {
+				var unknownPrefs = this.contactPrefs.get(Contacts.AppPrefs.Pref.unknownContacts);
+
+				var blockedNumbers = this.contactPrefs.get(Contacts.AppPrefs.Pref.blockedNumbers);
+
+				var unknownNumbers = this.contactPrefs.get(Contacts.AppPrefs.Pref.unknownNumbers);
+
+				if(((blockedNumbers) && (!contact.canBeCalled())) || ((unknownNumbers) && (!contact.personId))) {
+					if(unknownPrefs.callAction == "direct2vm")
+						this.flagCallRejected(callState.affectedCallId);
+					else if(unknownPrefs.callAction == "autohangup")
+						TelephonyCommands.disconnect(callState.affectedCallId);
+					else {
+						if((unknownPrefs.callAlert) && (unknownPrefs.callAlert != "default")) {
+							contact.callAlert = unknownPrefs.callAlert;
+						
+							if(unknownPrefs.callAlert == "ringtone")
+								contact.ringtoneLoc = unknownPrefs.callRingtonePath;
+						}
+					
+						this.announcer.announceIncoming(callState.affectedCallId, contact, this.isConnected());
+					}
+				}
+				else
+					this.announcer.announceIncoming(callState.affectedCallId, contact, this.isConnected());
+			}.bind(this, future.result));
+
 			return true; // continue
 		});
 		
--- .orig/usr/palm/applications/com.palm.app.phone/app/models/UIStateMachine.js
+++ /usr/palm/applications/com.palm.app.phone/app/models/UIStateMachine.js
@@ -28,6 +28,8 @@
 	/**
 	  * Phone UI states.
 	 **/
+	STATE_PREFS: 'prefs',
+
 	STATE_START: 'start',
 	STATE_PIN: 'pin', // pin scene
 	STATE_PIN_UNLOCKED: 'pin_unlocked',
@@ -67,6 +69,8 @@
 	
     initialize: function() {
 		this._states = {};
+
+		this._states[this.STATE_PREFS] = UIStateMachine.STATES.PrefsState;
 		
 		this._states[this.STATE_START] = UIStateMachine.STATES.StartState;
 		this._states[this.STATE_PIN] = UIStateMachine.STATES.PinState;
--- .orig/usr/palm/applications/com.palm.app.phone/resources/es/strings.json
+++ /usr/palm/applications/com.palm.app.phone/resources/es/strings.json
@@ -407,5 +407,48 @@
 	"synchronous circuit data switch": "conmutador de datos de circuito sincrónicos",
 	"via Email": "por correo electrónico",
 	"via Messaging": "por mensajería",
-	"voice": "voz"
+	"voice": "voz",
+	"Phone Services": "",
+	"Sound Settings": "",
+	"Default View": "",
+	"On Call View": "",
+	"No Default View": "",
+	"Slider Opened": "",
+	"Slider Closed": "",
+	"Power Button": "",
+	"On Dial Select": "",
+	"On TS Removal": "",
+	"On Proximity": "",
+	"On Call Reject": "",
+	"Repeat": "",
+	"Limitation": "",
+	"Dialpad": "",
+	"Call Log": "",
+	"Favorites: "",
+	"Contact": "",
+	"Keypad": "",
+	"Do Nothing": "",
+	"Answer Call": "",
+	"Speakerphone": "",
+	"Hangup Call": "",
+	"Start Call": "",
+	"Change Audio": "",
+	"Send SMS Reply": "",
+  "Sorry, I am currently busy and will call you back later...": "",
+	"Disabled": "",
+	"Every 2 minutes": "",
+	"Every 5 minutes": "",
+	"Every 15 minutes": "",
+	"Every 30 minutes": "",
+	"Every 60 minutes": "",
+	"Infinite": "",
+	"Repeat 3 times": "",
+	"Repeat 5 times": "",
+	"Repeat 10 times": "",
+	"Repeat 15 times": "",
+	"Repeat 30 times": "",
+	"Off": "",
+	"On": "",
+	"No": "",
+	"Yes": ""
 }
